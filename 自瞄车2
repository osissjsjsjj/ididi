if not game:IsLoaded() then
    game.Loaded:Wait()
end

if not syn or not protectgui then
    getgenv().protectgui = function() end
end

local SilentAimSettings = {
    Enabled = false,
    ClassName = "Universal Silent Aim",
    ToggleKey = "RightAlt",
    TeamCheck = false,
    VisibleCheck = false,
    TargetPart = "HumanoidRootPart",
    SilentAimMethod = "Raycast",
    FOVRadius = 130,
    FOVVisible = true,
    ShowSilentAimTarget = false,
    ShowTracer = false,
    MouseHitPrediction = false,
    MouseHitPredictionAmount = 0.165,
    HitChance = 100,
    FixedFOV = true,
    TargetIndicatorRadius = 20,
    IndicatorRotationEnabled = false,
    IndicatorRotationSpeed = 1,
    IndicatorRainbowEnabled = false,
    IndicatorRainbowSpeed = 1,
    MaxDistance = 500,
    Tracer_Y_Offset = 0,
    PriorityMode = "准星最近",
    TargetInfoStyle = "面板",
    ShowTargetName = false,
    ShowTargetHealth = false,
    ShowTargetDistance = false,
    ShowTargetCategory = false,
    ShowDamageNotifier = false,
    IndependentPanelPosition = "200,200",
    IndependentPanelPinned = false,
    LeakAndHitMode = false,
    Wallbang = false,
    EnableNameTargeting = false,
    TargetName1 = "",
    TargetName2 = "",
    TargetName3 = ""
}

getgenv().SilentAimSettings = SilentAimSettings
local MainFileName = "UniversalSilentAim"

local Camera = workspace.CurrentCamera
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local GuiService = game:GetService("GuiService")
local UserInputService = game:GetService("UserInputService")
local HttpService = game:GetService("HttpService")

local LocalPlayer = Players.LocalPlayer
local Mouse = LocalPlayer:GetMouse()

local GetPlayers = Players.GetPlayers
local WorldToViewportPoint = Camera.WorldToViewportPoint
local FindFirstChild = game.FindFirstChild
local RenderStepped = RunService.RenderStepped
local GetMouseLocation = UserInputService.GetMouseLocation

local resume = coroutine.resume
local create = coroutine.create

local ValidTargetParts = {"Head", "HumanoidRootPart"}
local PredictionAmount = 0.165

local currentTargetPart = nil
local currentRotationAngle = 0
local currentIndicatorHue = 0
local npcList = {}
local targetMap = {}
local lockedTargetCharacter = nil

local function getDirection(Origin, Position)
    local offset = Vector3.new(0.5, 0, 0)
    return (Position + offset - Origin).Unit * 1000
end

local target_indicator_circle = Drawing.new("Circle")
target_indicator_circle.Visible = false
target_indicator_circle.ZIndex = 1000
target_indicator_circle.Thickness = 2
target_indicator_circle.Filled = false

local target_indicator_lines = {}
for i = 1, 5 do
    local line = Drawing.new("Line")
    line.Visible = false
    line.ZIndex = 1000
    line.Thickness = 2
    table.insert(target_indicator_lines, line)
end

local tracer_line = Drawing.new("Line")
tracer_line.Visible = false
tracer_line.ZIndex = 998
tracer_line.Color = Color3.fromRGB(255, 255, 0)
tracer_line.Thickness = 1
tracer_line.Transparency = 1

local overhead_info_texts = {
    Name = Drawing.new("Text"),
    Health = Drawing.new("Text"),
    Distance = Drawing.new("Text"),
    Category = Drawing.new("Text")
}

for _, text in pairs(overhead_info_texts) do
    text.Visible = false
    text.ZIndex = 1001
    text.Font = Drawing.Fonts.Plex
    text.Size = 14
    text.Color = Color3.fromRGB(255, 255, 255)
    text.Center = true
    text.Outline = true
end

local panel_info_bg = Drawing.new("Square")
panel_info_bg.Visible = false
panel_info_bg.ZIndex = 1002
panel_info_bg.Color = Color3.fromRGB(0, 0, 0)
panel_info_bg.Thickness = 0
panel_info_bg.Filled = true
panel_info_bg.Transparency = 0.5

local panel_info_texts = {
    Name = Drawing.new("Text"),
    Health = Drawing.new("Text"),
    Distance = Drawing.new("Text"),
    Category = Drawing.new("Text")
}

for _, text in pairs(panel_info_texts) do
    text.Visible = false
    text.ZIndex = 1003
    text.Font = Drawing.Fonts.Plex
    text.Size = 14
    text.Color = Color3.fromRGB(255, 255, 255)
    text.Center = false
    text.Outline = true
end

local FOVCircleGui = Instance.new("ScreenGui", LocalPlayer:WaitForChild("PlayerGui"))
FOVCircleGui.Name = "FOVCircleGui"
FOVCircleGui.ResetOnSpawn = false
FOVCircleGui.IgnoreGuiInset = true
FOVCircleGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling

local FOVCircleFrame = Instance.new("Frame", FOVCircleGui)
FOVCircleFrame.Name = "FOVCircleFrame"
FOVCircleFrame.AnchorPoint = Vector2.new(0.5, 0.5)
FOVCircleFrame.Position = UDim2.fromScale(0.5, 0.5)
FOVCircleFrame.BackgroundTransparency = 1

local FOVStroke = Instance.new("UIStroke", FOVCircleFrame)
FOVStroke.Name = "FOVStroke"
FOVStroke.ApplyStrokeMode = Enum.ApplyStrokeMode.Border
FOVStroke.Thickness = 1
FOVStroke.Transparency = 0.5

local FOVCorner = Instance.new("UICorner", FOVCircleFrame)
FOVCorner.Name = "FOVCorner"
FOVCorner.CornerRadius = UDim.new(1, 0)

local IndependentPanelGui = Instance.new("ScreenGui", LocalPlayer:WaitForChild("PlayerGui"))
IndependentPanelGui.Name = "IndependentPanelGui"
IndependentPanelGui.ResetOnSpawn = false
IndependentPanelGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling

local IndependentPanelFrame = Instance.new("Frame", IndependentPanelGui)
IndependentPanelFrame.Name = "PanelFrame"
IndependentPanelFrame.Size = UDim2.fromOffset(160, 100)
IndependentPanelFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
IndependentPanelFrame.BackgroundTransparency = 0.3
IndependentPanelFrame.BorderSizePixel = 1
IndependentPanelFrame.BorderColor3 = Color3.new(1,1,1)
IndependentPanelFrame.Visible = false
IndependentPanelFrame.Active = true

local IPCorner = Instance.new("UICorner", IndependentPanelFrame)
IPCorner.CornerRadius = UDim.new(0, 4)

local IPListLayout = Instance.new("UIListLayout", IndependentPanelFrame)
IPListLayout.Padding = UDim.new(0, 5)
IPListLayout.SortOrder = Enum.SortOrder.LayoutOrder
IPListLayout.HorizontalAlignment = Enum.HorizontalAlignment.Center
IPListLayout.VerticalAlignment = Enum.VerticalAlignment.Center

local independent_panel_texts = {}
for i, name in ipairs({"Name", "Health", "Distance", "Category"}) do
    local label = Instance.new("TextLabel", IndependentPanelFrame)
    label.Name = name
    label.Size = UDim2.new(1, -10, 0, 15)
    label.BackgroundTransparency = 1
    label.Font = Enum.Font.SourceSans
    label.TextSize = 14
    label.TextColor3 = Color3.new(1,1,1)
    label.TextXAlignment = Enum.TextXAlignment.Left
    label.LayoutOrder = i
    independent_panel_texts[name] = label
end

IndependentPanelFrame.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 and IndependentPanelFrame.Draggable then
        IndependentPanelFrame.Position = UDim2.fromOffset(UserInputService:GetMouseLocation().X, UserInputService:GetMouseLocation().Y)
    end
end)

IndependentPanelFrame.InputEnded:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 and IndependentPanelFrame.Draggable then
        SilentAimSettings.IndependentPanelPosition = IndependentPanelFrame.Position.X.Offset .. "," .. IndependentPanelFrame.Position.Y.Offset
    end
end)

local ExpectedArguments = {
    FindPartOnRayWithIgnoreList = { ArgCountRequired = 3, Args = {"Instance", "Ray", "table", "boolean", "boolean"} },
    FindPartOnRayWithWhitelist = { ArgCountRequired = 3, Args = {"Instance", "Ray", "table", "boolean"} },
    FindPartOnRay = { ArgCountRequired = 2, Args = {"Instance", "Ray", "Instance", "boolean", "boolean"} },
    Raycast = { ArgCountRequired = 3, Args = {"Instance", "Vector3", "Vector3", "RaycastParams"} }
}

function CalculateChance(Percentage)
    Percentage = math.floor(Percentage)
    return math.random() <= Percentage / 100
end

if not isfolder or not makefolder then
    isfolder = function() return true end
    makefolder = function() end
end

do
    if not isfolder(MainFileName) then makefolder(MainFileName) end
    local folderPath = string.format("%s/%s", MainFileName, tostring(game.PlaceId))
    if not isfolder(folderPath) then makefolder(folderPath) end
end

local function getPositionOnScreen(Vector)
    local Vec3, OnScreen = WorldToViewportPoint(Camera, Vector)
    return Vector2.new(Vec3.X, Vec3.Y), OnScreen
end

local function ValidateArguments(Args, RayMethod)
    local Matches = 0
    if #Args < RayMethod.ArgCountRequired then return false end
    for Pos, Argument in next, Args do
        if typeof(Argument) == RayMethod.Args[Pos] then
            Matches = Matches + 1
        end
    end
    return Matches >= RayMethod.ArgCountRequired
end

local function isNPC(obj)
    return obj:IsA("Model") and obj:FindFirstChild("Humanoid") and obj.Humanoid.Health > 0 and obj:FindFirstChild("HumanoidRootPart") and not Players:GetPlayerFromCharacter(obj)
end

function getTargetCategory(character)
    if not character then return "无" end
    if Players:GetPlayerFromCharacter(character) then return "玩家" end
    if SilentAimSettings.EnableNameTargeting then
        local name = character.Name:lower()
        local t1 = SilentAimSettings.TargetName1:lower()
        local t2 = SilentAimSettings.TargetName2:lower()
        local t3 = SilentAimSettings.TargetName3:lower()
        if (t1 ~= "" and string.find(name, t1, 1, true)) or (t2 ~= "" and string.find(name, t2, 1, true)) or (t3 ~= "" and string.find(name, t3, 1, true)) then
            return "添加的"
        end
    end
    if character:FindFirstChild("Humanoid") then return "NPC" end
    return "未知"
end

local function updateNPCs()
    local newNpcList = {}
    local addedNpcs = {}
    if SilentAimSettings.EnableNameTargeting then
        local targetSubstrings = {}
        if SilentAimSettings.TargetName1 and SilentAimSettings.TargetName1 ~= "" then table.insert(targetSubstrings, SilentAimSettings.TargetName1:lower()) end
        if SilentAimSettings.TargetName2 and SilentAimSettings.TargetName2 ~= "" then table.insert(targetSubstrings, SilentAimSettings.TargetName2:lower()) end
        if SilentAimSettings.TargetName3 and SilentAimSettings.TargetName3 ~= "" then table.insert(targetSubstrings, SilentAimSettings.TargetName3:lower()) end
        if #targetSubstrings > 0 then
            for _, model in ipairs(workspace:GetDescendants()) do
                if isNPC(model) then
                    for _, substring in ipairs(targetSubstrings) do
                        if string.find(model.Name:lower(), substring, 1, true) then
                            if not addedNpcs[model] then
                                table.insert(newNpcList, model)
                                addedNpcs[model] = true
                                break
                            end
                        end
                    end
                end
            end
        end
    end
    for _, v in ipairs(workspace:GetChildren()) do
        if isNPC(v) then
            if not addedNpcs[v] then
                table.insert(newNpcList, v)
                addedNpcs[v] = true
            end
        end
    end
    npcList = newNpcList
end

local function isPartVisible(part, customOrigin)
    if not part then return false end
    local localCharacter = LocalPlayer.Character
    if not localCharacter then return false end
    local origin = customOrigin or Camera.CFrame.Position
    local direction = part.Position - origin
    local raycastParams = RaycastParams.new()
    raycastParams.FilterType = Enum.RaycastFilterType.Exclude
    raycastParams.FilterDescendantsInstances = {localCharacter, part.Parent}
    local raycastResult = workspace:Raycast(origin, direction.Unit * direction.Magnitude, raycastParams)
    return not raycastResult
end

local function getClosestPlayer()
    local LocalPlayerCharacter = LocalPlayer.Character
    if not LocalPlayerCharacter or not LocalPlayerCharacter:FindFirstChild("HumanoidRootPart") then return nil end
    local localRoot = LocalPlayerCharacter.HumanoidRootPart
    local AimPoint = SilentAimSettings.FixedFOV and (Camera.ViewportSize / 2) or GetMouseLocation(UserInputService)
    local candidates = {}
    for _, Player in ipairs(GetPlayers(Players)) do
        if Player ~= LocalPlayer and not (SilentAimSettings.TeamCheck and Player.Team == LocalPlayer.Team) then
            local Character = Player.Character
            local Humanoid = Character and Character:FindFirstChildOfClass("Humanoid")
            if Character and Character:FindFirstChild("HumanoidRootPart") and Humanoid and Humanoid.Health > 0 then
                if not (SilentAimSettings.VisibleCheck and not isPartVisible(Character.HumanoidRootPart, LocalPlayerCharacter.Head.Position)) then
                    local physicalDist = (localRoot.Position - Character.HumanoidRootPart.Position).Magnitude
                    if physicalDist <= SilentAimSettings.MaxDistance then
                        local TargetPartName = SilentAimSettings.TargetPart
                        local PartToAim = FindFirstChild(Character, TargetPartName) or Character.HumanoidRootPart
                        if TargetPartName == "Random" then PartToAim = Character[ValidTargetParts[math.random(1, #ValidTargetParts)]] end
                        if PartToAim then
                            local ScreenPosition, OnScreen = getPositionOnScreen(PartToAim.Position)
                            if OnScreen then
                                local fovDist = (AimPoint - ScreenPosition).Magnitude
                                if fovDist <= SilentAimSettings.FOVRadius then
                                    table.insert(candidates, {character = Character, fov = fovDist, dist = physicalDist, health = Humanoid.Health})
                                end
                            end
                        end
                    end
                end
            end
        end
    end
    if #candidates == 0 then return nil end
    table.sort(candidates, function(a, b)
        if SilentAimSettings.PriorityMode == "最低血量" then
            return a.health < b.health
        elseif SilentAimSettings.PriorityMode == "距离最近" then
            return a.dist < b.dist
        else
            return a.fov < b.fov
        end
    end)
    return candidates[1].character
end

local function getNPCTarget()
    local LocalPlayerCharacter = LocalPlayer.Character
    if not LocalPlayerCharacter or not LocalPlayerCharacter:FindFirstChild("HumanoidRootPart") then return nil end
    local localRoot = LocalPlayerCharacter.HumanoidRootPart
    local AimPoint = SilentAimSettings.FixedFOV and (Camera.ViewportSize / 2) or GetMouseLocation(UserInputService)
    local candidates = {}
    for _, NPCModel in ipairs(npcList) do
        if not (SilentAimSettings.TeamCheck and NPCModel.Team and NPCModel.Team == LocalPlayer.Team) then
            local Humanoid = NPCModel and NPCModel:FindFirstChildOfClass("Humanoid")
            if NPCModel and NPCModel.PrimaryPart and Humanoid and Humanoid.Health > 0 then
                if not (SilentAimSettings.VisibleCheck and not isPartVisible(NPCModel.PrimaryPart, LocalPlayerCharacter.Head.Position)) then
                    local physicalDist = (localRoot.Position - NPCModel.PrimaryPart.Position).Magnitude
                    if physicalDist <= SilentAimSettings.MaxDistance then
                        local TargetPartName = SilentAimSettings.TargetPart
                        local PartToAim = FindFirstChild(NPCModel, TargetPartName) or NPCModel.PrimaryPart
                        if TargetPartName == "Random" then PartToAim = NPCModel[ValidTargetParts[math.random(1, #ValidTargetParts)]] end
                        if PartToAim then
                            local ScreenPosition, OnScreen = getPositionOnScreen(PartToAim.Position)
                            if OnScreen then
                                local fovDist = (AimPoint - ScreenPosition).Magnitude
                                if fovDist <= SilentAimSettings.FOVRadius then
                                    table.insert(candidates, {character = NPCModel, fov = fovDist, dist = physicalDist, health = Humanoid.Health})
                                end
                            end
                        end
                    end
                end
            end
        end
    end
    if #candidates == 0 then return nil end
    table.sort(candidates, function(a, b)
        if SilentAimSettings.PriorityMode == "最低血量" then
            return a.health < b.health
        elseif SilentAimSettings.PriorityMode == "距离最近" then
            return a.dist < b.dist
        else
            return a.fov < b.fov
        end
    end)
    return candidates[1].character
end

function getPolygonPoints(center, radius, sides)
    local points = {}
    local rotationOffset = SilentAimSettings.IndicatorRotationEnabled and currentRotationAngle or 0
    for i = 1, sides do
        local angle = (i - 1) * (2 * math.pi / sides) - (math.pi / 2) + rotationOffset
        table.insert(points, Vector2.new(center.X + radius * math.cos(angle), center.Y + radius * math.sin(angle)))
    end
    return points
end

function hideAllVisuals()
    target_indicator_circle.Visible = false
    for _, line in ipairs(target_indicator_lines) do line.Visible = false end
    for _, text in pairs(overhead_info_texts) do text.Visible = false end
    panel_info_bg.Visible = false
    for _, text in pairs(panel_info_texts) do text.Visible = false end
    if IndependentPanelFrame then IndependentPanelFrame.Visible = false end
end

hideAllVisuals()
print("脚本已加载完成（语法修复版）")
